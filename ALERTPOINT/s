<!-- Interactive Map -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center space-x-4">
                                <h3 class="text-lg font-semibold text-gray-900">Evacuation Map</h3>
                                <!-- Search Bar -->
                                <div class="relative">
                                    <input type="text" 
                                        id="address-search" 
                                        placeholder="Search address..." 
                                        class="w-80 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <button id="search-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-blue-600">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="zoom-in" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button id="zoom-out" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button id="reset-view" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Reset View
                                </button>
                            </div>
                        </div>
                        <div id="evacuation-map" class="w-full h-100 rounded-lg border"></div>
                    </div>
                </div>
            </div>



            <script>
                // Time and Date
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleString('en-PH', {
        timeZone: 'Asia/Manila',
        year: 'numeric',
        month: 'long',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    const timeElement = document.getElementById('current-time');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}

setInterval(updateTime, 1000);
updateTime(); // call on initial load

            // Initialize map variables
            let map;
            let evacuationRoutes = [];
            let evacuationCenters = [];
            let hardwareUnits = [];
            let modalHardwareMap;
            let modalCenterMap;
            let editingCenterId = null;
            let currentBarangayLocation = [14.73927547331345, 121.03462297276172]; // Default Barangay 170
            let searchResultMarker = null;
            let barangayHallMarker = null;
            let selectedSearchResult = null;

            function initializeMap() {
                // Initialize map with enhanced tile layers
                map = L.map('evacuation-map').setView(currentBarangayLocation, 16);

                // Multiple tile layer options for better detail
                const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                });

                const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                    maxZoom: 18
                });

                const topoLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)',
                    maxZoom: 17
                });

                // Add default layer
                streetLayer.addTo(map);

                // Layer control
                const baseLayers = {
                    "Street Map": streetLayer,
                    "Satellite": satelliteLayer,
                    "Topographic": topoLayer
                };
                L.control.layers(baseLayers).addTo(map);

                // Add current Barangay Hall marker
                updateBarangayHallMarker();

                // Initialize geocoder for search
                initializeGeocoder();
            }

            // ADD THIS NEW FUNCTION FOR GEOCODER
            function initializeGeocoder() {
                const geocoder = L.Control.Geocoder.nominatim();
                
                // Search functionality
                document.getElementById('search-btn').addEventListener('click', performSearch);
                document.getElementById('address-search').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }

            // ADD THIS NEW FUNCTION FOR SEARCH
            function performSearch() {
                const query = document.getElementById('address-search').value.trim();
                if (!query) return;

                // Show loading state
                const searchBtn = document.getElementById('search-btn');
                const originalContent = searchBtn.innerHTML;
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                // Prioritize Philippines locations in search
                const geocoder = L.Control.Geocoder.nominatim({
                    geocodingQueryParams: {
                        countrycodes: 'ph',
                        bounded: 1,
                        viewbox: '116.9283,4.5693,126.6043,21.0794' // Philippines bounding box
                    }
                });

                geocoder.geocode(query, function(results) {
                    searchBtn.innerHTML = originalContent;
                    
                    if (results.length > 0) {
                        const result = results[0];
                        const latlng = result.center;
                        
                        // Remove previous search result marker
                        if (searchResultMarker) {
                            map.removeLayer(searchResultMarker);
                        }
                        
                        // Add new search result marker
                        searchResultMarker = L.marker([latlng.lat, latlng.lng], {
                            icon: L.divIcon({
                                className: 'search-result-marker',
                                html: '<i class="fas fa-map-pin text-2xl text-red-500"></i>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(map);
                        
                        // Create popup with option to set as barangay hall
                        const popupContent = `
                            <div class="search-result-popup">
                                <b>Search Result</b><br>
                                <p class="text-sm">${result.name}</p>
                                <div class="mt-3">
                                    <button onclick="setAsBarangayHall('${result.name}', ${latlng.lat}, ${latlng.lng})" 
                                            class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                        <i class="fas fa-home mr-1"></i>Set as Barangay Hall
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        searchResultMarker.bindPopup(popupContent).openPopup();
                        
                        // Center map on result
                        map.setView([latlng.lat, latlng.lng], 17);
                        
                        // Store result for modal
                        selectedSearchResult = {
                            name: result.name,
                            lat: latlng.lat,
                            lng: latlng.lng
                        };
                        
                    } else {
                        alert('Location not found. Please try a different search term.');
                    }
                });
            }

            // ADD THIS NEW FUNCTION TO SET BARANGAY HALL LOCATION
            function setAsBarangayHall(name, lat, lng) {
                selectedSearchResult = { name, lat, lng };
                document.getElementById('selected-address').textContent = name;
                document.getElementById('selected-coordinates').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                document.getElementById('set-barangay-location-modal').classList.remove('hidden');
            }

            // ADD THIS NEW FUNCTION TO UPDATE BARANGAY HALL MARKER
            function updateBarangayHallMarker() {
                // Remove existing marker
                if (barangayHallMarker) {
                    map.removeLayer(barangayHallMarker);
                }
                
                // Add new barangay hall marker
                barangayHallMarker = L.marker(currentBarangayLocation, {
                    icon: L.divIcon({
                        className: 'barangay-hall-marker',
                        html: '<i class="fas fa-building text-2xl text-blue-600"></i>',
                        iconSize: [35, 35],
                        iconAnchor: [17, 35]
                    })
                }).addTo(map)
                .bindPopup("<b>Barangay Hall</b><br>Main Command Center")
                .openPopup();
            }


            // ADD THESE EVENT LISTENERS TO THE EXISTING DOMContentLoaded SECTION
            document.getElementById('confirm-location-change').addEventListener('click', function() {
                if (selectedSearchResult) {
                    // Update barangay location
                    currentBarangayLocation = [selectedSearchResult.lat, selectedSearchResult.lng];
                    
                    // Update marker
                    updateBarangayHallMarker();
                    
                    // Recalculate all routes
                    updateRouteDisplay();
                    updateEvacuationTimeEstimate();
                    
                    // Remove search result marker since it's now the barangay hall
                    if (searchResultMarker) {
                        map.removeLayer(searchResultMarker);
                        searchResultMarker = null;
                    }
                    
                    // Clear search
                    document.getElementById('address-search').value = '';
                    
                    // Close modal
                    document.getElementById('set-barangay-location-modal').classList.add('hidden');
                    
                    // Show success message
                    alert('Barangay Hall location updated successfully!');
                    
                    // Center map on new location
                    map.setView(currentBarangayLocation, 16);
                }
            });

            document.getElementById('cancel-location-change').addEventListener('click', function() {
                document.getElementById('set-barangay-location-modal').classList.add('hidden');
            });


            let modalMode = null; // Track which modal is active
            let modalClickHandler = null; // Store click handler reference

            function initializeModalMaps() {
                // // Initialize hardware modal map
                // modalHardwareMap = L.map('modal-hardware-map').setView([14.73927547331345, 121.03462297276172], 16);
                // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                //     attribution: '© OpenStreetMap contributors'
                // }).addTo(modalHardwareMap);

                // // Initialize center modal map  
                // modalCenterMap = L.map('modal-center-map').setView([14.73927547331345, 121.03462297276172], 16);
                // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                //     attribution: '© OpenStreetMap contributors'
                // }).addTo(modalCenterMap);

                // // Add click handlers
                // modalHardwareMap.on('click', function(e) {
                //     addHardwareToMap(e.latlng);
                //     document.getElementById('hardware-modal').classList.add('hidden');
                // });

                // modalCenterMap.on('click', function(e) {
                //     addCenterToMap(e.latlng);
                //     document.getElementById('center-modal').classList.add('hidden');
                // });
            }

            // Hardware management
            function addHardwareToMap(latlng, name, type) {
                // Use parameters if provided, otherwise get from form (for backward compatibility)
                if (!name) {
                    name = document.getElementById('hardware-name').value;
                    type = document.getElementById('hardware-type').value;
                }
                
                if (!name) {
                    alert('Please enter a hardware name');
                    return;
                }

                const hardware = {
                    id: Date.now(),
                    name: name,
                    type: type,
                    lat: latlng.lat,
                    lng: latlng.lng
                };

                const icon = type === 'barangay' ? 'fas fa-building' : 'fas fa-water';
                const color = type === 'barangay' ? 'text-blue-600' : 'text-teal-600';

                const marker = L.marker([latlng.lat, latlng.lng], {
                    icon: L.divIcon({
                        className: 'hardware-marker',
                        html: `<i class="${icon} text-xl ${color}"></i>`,
                        iconSize: [25, 25],
                        iconAnchor: [12, 25]
                    })
                }).addTo(map)
                .bindPopup(`<b>${name}</b><br>Type: ${type === 'barangay' ? 'Barangay Unit' : 'Creek Unit'}`);

                hardware.marker = marker;
                hardwareUnits.push(hardware);
                
                updateHardwareList();
                updateStats();
                
                // Clear form
                document.getElementById('hardware-name').value = '';
            }

            // Evacuation center management
            function addCenterToMap(latlng, name, capacity, status) {
                // Use parameters if provided, otherwise get from form (for backward compatibility)
                if (!name) {
                    name = document.getElementById('center-name').value;
                    capacity = document.getElementById('center-capacity').value;
                    status = document.getElementById('center-status').value;
                }
                
                if (!name || !capacity) {
                    alert('Please fill in all fields');
                    return;
                }

                const center = {
                    id: Date.now(),
                    name: name,
                    capacity: parseInt(capacity),
                    status: status,
                    lat: latlng.lat,
                    lng: latlng.lng
                };

                const statusColor = getStatusColor(status);
                const marker = L.marker([latlng.lat, latlng.lng], {
                    icon: L.divIcon({
                        className: 'center-marker',
                        html: `<i class="fas fa-home text-xl ${statusColor}"></i>`,
                        iconSize: [25, 25],
                        iconAnchor: [12, 25]
                    })
                }).addTo(map)
                .bindPopup(`
                    <b>${name}</b><br>
                    Capacity: ${capacity} persons<br>
                    Status: <span class="${statusColor.replace('text-', 'text-')}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `);

                center.marker = marker;
                evacuationCenters.push(center);
                
                updateCentersList();
                updateStats();
                updateRouteDisplay();

                // Clear form
                document.getElementById('center-name').value = '';
                document.getElementById('center-capacity').value = '';
            }

            function getStatusColor(status) {
                switch(status) {
                    case 'active': return 'text-green-600';
                    case 'standby': return 'text-yellow-600';
                    case 'full': return 'text-red-600';
                    default: return 'text-gray-600';
                }
            }

            function updateHardwareList() {
                const list = document.getElementById('hardware-list');
                
                if (hardwareUnits.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm">No hardware units added yet. Click "Add Hardware Pin" to start.</p>';
                    return;
                }

                list.innerHTML = hardwareUnits.map(hardware => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="focusOnMarker(${hardware.lat}, ${hardware.lng})">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">${hardware.name}</h4>
                                <p class="text-sm text-gray-600">Type: ${hardware.type === 'barangay' ? 'Barangay Unit' : 'Creek Unit'}</p>
                                <p class="text-xs text-gray-500">${hardware.lat.toFixed(6)}, ${hardware.lng.toFixed(6)}</p>
                            </div>
                            <i class="fas fa-${hardware.type === 'barangay' ? 'building' : 'water'} ${hardware.type === 'barangay' ? 'text-blue-600' : 'text-teal-600'}"></i>
                        </div>
                    </div>
                `).join('');
            }

            function updateCentersList() {
                const list = document.getElementById('evacuation-centers-list');
                
                if (evacuationCenters.length === 0) {
                    list.innerHTML = '<p class="text-gray-500 text-sm">No evacuation centers added yet. Click "Add Evacuation Center" to start.</p>';
                    return;
                }

                list.innerHTML = evacuationCenters.map(center => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="cursor-pointer flex-1" onclick="focusOnMarker(${center.lat}, ${center.lng})">
                                <h4 class="font-semibold text-gray-900">${center.name}</h4>
                                <p class="text-sm text-gray-600">Capacity: ${center.capacity} persons</p>
                                <p class="text-xs ${getStatusColor(center.status)} font-medium">${center.status.charAt(0).toUpperCase() + center.status.slice(1)}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editCenter(${center.id})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function editCenter(centerId) {
                const center = evacuationCenters.find(c => c.id === centerId);
                if (!center) return;

                editingCenterId = centerId;
                document.getElementById('edit-center-name').value = center.name;
                document.getElementById('edit-center-capacity').value = center.capacity;
                document.getElementById('edit-center-status').value = center.status;
                document.getElementById('edit-center-modal').classList.remove('hidden');
            }

            function saveCenter() {
                const center = evacuationCenters.find(c => c.id === editingCenterId);
                if (!center) return;

                const name = document.getElementById('edit-center-name').value;
                const capacity = document.getElementById('edit-center-capacity').value;
                const status = document.getElementById('edit-center-status').value;

                if (!name || !capacity) {
                    alert('Please fill in all fields');
                    return;
                }

                center.name = name;
                center.capacity = parseInt(capacity);
                center.status = status;

                // Update marker
                const statusColor = getStatusColor(status);
                center.marker.setIcon(L.divIcon({
                    className: 'center-marker',
                    html: `<i class="fas fa-home text-xl ${statusColor}"></i>`,
                    iconSize: [25, 25],
                    iconAnchor: [12, 25]
                }));

                center.marker.setPopupContent(`
                    <b>${name}</b><br>
                    Capacity: ${capacity} persons<br>
                    Status: <span class="${statusColor.replace('text-', 'text-')}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                `);

                updateCentersList();
                document.getElementById('edit-center-modal').classList.add('hidden');
                editingCenterId = null;
            }

            function deleteCenter() {
                if (!confirm('Are you sure you want to delete this evacuation center?')) return;

                const centerIndex = evacuationCenters.findIndex(c => c.id === editingCenterId);
                if (centerIndex === -1) return;

                const center = evacuationCenters[centerIndex];
                map.removeLayer(center.marker);
                evacuationCenters.splice(centerIndex, 1);

                updateCentersList();
                updateStats();
                updateRouteDisplay();

                document.getElementById('edit-center-modal').classList.add('hidden');
                editingCenterId = null;
            }

            function focusOnMarker(lat, lng) {
                map.setView([lat, lng], 18);
                
                // Find and open popup for the marker at this location
                const allMarkers = [...hardwareUnits, ...evacuationCenters];
                const marker = allMarkers.find(item => 
                    Math.abs(item.lat - lat) < 0.0001 && Math.abs(item.lng - lng) < 0.0001
                );
                if (marker && marker.marker) {
                    marker.marker.openPopup();
                }
            }

            function updateStats() {
                document.getElementById('evacuation-centers-count').textContent = evacuationCenters.length;
                document.getElementById('hardware-count').textContent = hardwareUnits.length;
            }

            // Event listeners
            document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
            document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());
            document.getElementById('reset-view').addEventListener('click', () => {
                map.setView(currentBarangayLocation, 16); // Updated to use current location
            });

            // Hardware modal handlers - UPDATED
            // Hardware modal handlers - UPDATED
            document.getElementById('add-hardware').addEventListener('click', () => {
                document.getElementById('hardware-modal').classList.remove('hidden');
            });

            document.getElementById('cancel-hardware').addEventListener('click', () => {
                document.getElementById('hardware-modal').classList.add('hidden');
                cancelModalMode();
            });

            document.getElementById('confirm-hardware').addEventListener('click', () => {
                const name = document.getElementById('hardware-name').value.trim();
                const type = document.getElementById('hardware-type').value;
                
                if (!name) {
                    alert('Please enter a hardware name');
                    return;
                }
                
                // Close modal and activate placement mode
                document.getElementById('hardware-modal').classList.add('hidden');
                activateHardwarePlacementMode(name, type);
            });

            // Center modal handlers - UPDATED
            // Center modal handlers - UPDATED
            document.getElementById('add-evacuation-center').addEventListener('click', () => {
                document.getElementById('center-modal').classList.remove('hidden');
            });

            document.getElementById('cancel-center').addEventListener('click', () => {
                document.getElementById('center-modal').classList.add('hidden');
                cancelModalMode();
            });

            document.getElementById('confirm-center').addEventListener('click', () => {
                const name = document.getElementById('center-name').value.trim();
                const capacity = document.getElementById('center-capacity').value;
                const status = document.getElementById('center-status').value;
                
                if (!name || !capacity) {
                    alert('Please fill in all fields');
                    return;
                }
                
                // Close modal and activate placement mode
                document.getElementById('center-modal').classList.add('hidden');
                activateCenterPlacementMode(name, capacity, status);
            });

            // Edit center modal handlers
            document.getElementById('cancel-edit-center').addEventListener('click', () => {
                document.getElementById('edit-center-modal').classList.add('hidden');
                editingCenterId = null;
            });

            document.getElementById('save-center').addEventListener('click', saveCenter);
            document.getElementById('delete-center').addEventListener('click', deleteCenter);

            // Emergency activation
            document.getElementById('activate-emergency').addEventListener('click', () => {
                const statusBar = document.getElementById('emergency-status');
                statusBar.className = 'bg-red-50 border-l-4 border-red-400 p-4 rounded-lg mb-6';
                statusBar.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-400 mr-3 text-2xl animate-pulse"></i>
                        <div>
                            <h3 class="text-sm font-medium text-red-800">EMERGENCY ACTIVATED</h3>
                            <p class="text-sm text-red-700">All evacuation routes are now active. Residents should proceed to nearest evacuation center.</p>
                        </div>
                    </div>
                `;
                
                // Show deactivate button, hide activate button
                document.getElementById('activate-emergency').classList.add('hidden');
                document.getElementById('deactivate-emergency').classList.remove('hidden');
                
                // Show all evacuation routes
                showAllEvacuationRoutes();
                
                alert('Emergency evacuation protocol activated. Mass alerts will be sent to all registered users.');
            });

            document.getElementById('test-evacuation').addEventListener('click', () => {
                alert('Test evacuation drill initiated. This will send test alerts to all registered users.');
            });

            document.getElementById('send-alerts').addEventListener('click', () => {
                alert('Mass alert sent to all registered users in Barangay 170.');
            });



            // Deactivate Emergency
            document.getElementById('deactivate-emergency').addEventListener('click', () => {
                const statusBar = document.getElementById('emergency-status');
                statusBar.className = 'bg-green-50 border-l-4 border-green-400 p-4 rounded-lg mb-6';
                statusBar.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-shield-alt text-green-400 mr-3 text-2xl"></i>
                        <div>
                            <h3 class="text-sm font-medium text-green-800">Current Status: NORMAL</h3>
                            <p class="text-sm text-green-700">No active emergencies. All evacuation routes are clear and accessible.</p>
                        </div>
                    </div>
                `;
                
                // Show activate button, hide deactivate button
                document.getElementById('activate-emergency').classList.remove('hidden');
                document.getElementById('deactivate-emergency').classList.add('hidden');
                
                // Clear routes if not checked
                updateRouteDisplay();
                
                alert('Emergency status returned to normal.');
            });

            // Mass alert modal handlers
            document.getElementById('send-alerts').addEventListener('click', () => {
                document.getElementById('alert-modal').classList.remove('hidden');
            });

            document.getElementById('cancel-alert').addEventListener('click', () => {
                document.getElementById('alert-modal').classList.add('hidden');
            });

            document.getElementById('alert-level').addEventListener('change', updateAlertPreview);
            document.getElementById('alert-message').addEventListener('input', updateAlertPreview);

            document.getElementById('send-alert').addEventListener('click', () => {
                const level = document.getElementById('alert-level').value;
                const message = document.getElementById('alert-message').value;
                
                if (!message.trim()) {
                    alert('Please enter an alert message');
                    return;
                }
                
                const levelText = document.getElementById('alert-level').selectedOptions[0].text;
                alert(`${levelText} alert sent to all registered users:\n"${message}"`);
                
                // Clear form and close modal
                document.getElementById('alert-message').value = '';
                document.getElementById('alert-modal').classList.add('hidden');
            });

            // Route checkbox handlers
            document.getElementById('route-primary').addEventListener('change', updateRouteDisplay);
            document.getElementById('route-secondary').addEventListener('change', updateRouteDisplay);
            document.getElementById('route-emergency').addEventListener('change', updateRouteDisplay);







            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
              const modals = ['hardware-modal', 'center-modal', 'edit-center-modal', 'alert-modal'];
              modals.forEach(modalId => {
                  const modal = document.getElementById(modalId);
                  if (e.target === modal) {
                      modal.classList.add('hidden');
                      editingCenterId = null;
                  }
              });
          });

            // Initialize everything - UPDATED
            document.addEventListener('DOMContentLoaded', function() {
                updateTime();
                setInterval(updateTime, 1000);
                initializeMap();
                initializeModalMaps();
                updateStats();
            });


        
        function updateAlertPreview() {
            const level = document.getElementById('alert-level').value;
            const message = document.getElementById('alert-message').value || 'Your message will appear here...';
            
            const levelColors = {
                green: 'text-green-600',
                yellow: 'text-yellow-600', 
                orange: 'text-orange-600',
                red: 'text-red-600'
            };
            
            const levelText = level.toUpperCase() + ' CODE';
            document.getElementById('preview-level').textContent = levelText;
            document.getElementById('preview-level').className = `font-semibold ${levelColors[level]}`;
            document.getElementById('preview-message').textContent = message;
        }

function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = lat1 * Math.PI/180;
    const φ2 = lat2 * Math.PI/180;
    const Δφ = (lat2-lat1) * Math.PI/180;
    const Δλ = (lng2-lng1) * Math.PI/180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c; // Distance in meters
}

function estimateEvacuationTime(distance) {
    // Assume average walking speed of 1.2 m/s (4.3 km/h) for evacuation
    const walkingSpeed = 1.2; // m/s
    const timeInSeconds = distance / walkingSpeed;
    
    if (timeInSeconds < 60) {
        return Math.round(timeInSeconds) + ' sec';
    } else if (timeInSeconds < 3600) {
        return Math.round(timeInSeconds / 60) + ' min';
    } else {
        return Math.round(timeInSeconds / 3600 * 10) / 10 + ' hrs';
    }
}

function createEvacuationRoute(center, routeType) {
    const barangayHall = currentBarangayLocation; // Updated to use current location
    const centerCoords = [center.lat, center.lng];
    
    // Calculate distance and time
    const distance = calculateDistance(barangayHall[0], barangayHall[1], center.lat, center.lng);
    const estimatedTime = estimateEvacuationTime(distance);
    
    // Create different route paths based on type
    let routeCoords;
    if (routeType === 'primary') {
        // Direct route
        routeCoords = [barangayHall, centerCoords];
    } else if (routeType === 'secondary') {
        // Alternative route with a waypoint
        const midLat = (barangayHall[0] + center.lat) / 2 + 0.002;
        const midLng = (barangayHall[1] + center.lng) / 2 + 0.003;
        routeCoords = [barangayHall, [midLat, midLng], centerCoords];
    } else { // emergency
        // Most direct route
        routeCoords = [barangayHall, centerCoords];
    }
    
    const route = L.polyline(routeCoords, {
        className: `evacuation-route route-${routeType}`,
        weight: 4,
        opacity: 0.8
    }).addTo(map);
    
    // Add popup with route information
    const routeTypeText = routeType.charAt(0).toUpperCase() + routeType.slice(1);
    route.bindPopup(`
        <div class="route-info-popup">
            <b>${routeTypeText} Route to ${center.name}</b><br>
            Distance: ${(distance/1000).toFixed(2)} km<br>
            Estimated Time: ${estimatedTime}<br>
            Capacity: ${center.capacity} persons
        </div>
    `);
    
    return route;
}

function updateRouteDisplay() {
    // Clear existing routes
    evacuationRoutes.forEach(route => map.removeLayer(route));
    evacuationRoutes = [];
    
    const showPrimary = document.getElementById('route-primary').checked;
    const showSecondary = document.getElementById('route-secondary').checked;
    const showEmergency = document.getElementById('route-emergency').checked;
    
    evacuationCenters.forEach(center => {
        if (showPrimary) {
            evacuationRoutes.push(createEvacuationRoute(center, 'primary'));
        }
        if (showSecondary) {
            evacuationRoutes.push(createEvacuationRoute(center, 'secondary'));
        }
        if (showEmergency) {
            evacuationRoutes.push(createEvacuationRoute(center, 'emergency'));
        }
    });
    
    // Update evacuation time estimate
    updateEvacuationTimeEstimate();
}

function showAllEvacuationRoutes() {
    // Check all route options during emergency
    document.getElementById('route-primary').checked = true;
    document.getElementById('route-secondary').checked = true;
    document.getElementById('route-emergency').checked = true;
    updateRouteDisplay();
}

function updateEvacuationTimeEstimate() {
    if (evacuationCenters.length === 0) {
        document.getElementById('evacuation-time').textContent = '45 min';
        return;
    }
    
    // Find the nearest evacuation center from current barangay hall location
    const barangayHall = currentBarangayLocation; // Updated to use current location
    let minDistance = Infinity;
    
    evacuationCenters.forEach(center => {
        const distance = calculateDistance(barangayHall[0], barangayHall[1], center.lat, center.lng);
        if (distance < minDistance) {
            minDistance = distance;
        }
    });
    
    const estimatedTime = estimateEvacuationTime(minDistance);
    document.getElementById('evacuation-time').textContent = estimatedTime;
}


function activateHardwarePlacementMode(name, type) {
    modalMode = 'hardware';
    
    // Remove any existing click handler
    if (modalClickHandler) {
        map.off('click', modalClickHandler);
    }
    
    // Add new click handler
    modalClickHandler = function(e) {
        addHardwareToMap(e.latlng, name, type);
        cancelModalMode();
    };
    
    map.on('click', modalClickHandler);
    
    // Change cursor to indicate placement mode
    document.getElementById('evacuation-map').style.cursor = 'crosshair';
    
    // Show instruction message
    showPlacementInstruction('Click on the map to place the hardware unit');
}

function activateCenterPlacementMode(name, capacity, status) {
    modalMode = 'center';
    
    // Remove any existing click handler
    if (modalClickHandler) {
        map.off('click', modalClickHandler);
    }
    
    // Add new click handler
    modalClickHandler = function(e) {
        addCenterToMap(e.latlng, name, capacity, status);
        cancelModalMode();
    };
    
    map.on('click', modalClickHandler);
    
    // Change cursor to indicate placement mode
    document.getElementById('evacuation-map').style.cursor = 'crosshair';
    
    // Show instruction message
    showPlacementInstruction('Click on the map to place the evacuation center');
}

function cancelModalMode() {
    if (modalClickHandler) {
        map.off('click', modalClickHandler);
        modalClickHandler = null;
    }
    modalMode = null;
    document.getElementById('evacuation-map').style.cursor = '';
    hidePlacementInstruction();
}

function showPlacementInstruction(message) {
    // Create or update instruction overlay
    let instruction = document.getElementById('placement-instruction');
    if (!instruction) {
        instruction = document.createElement('div');
        instruction.id = 'placement-instruction';
        instruction.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50';
        document.body.appendChild(instruction);
    }
    instruction.textContent = message;
    instruction.classList.remove('hidden');
}

function hidePlacementInstruction() {
    const instruction = document.getElementById('placement-instruction');
    if (instruction) {
        instruction.classList.add('hidden');
    }
}


// ADD TO THE EXISTING MODAL CLOSE EVENT LISTENERS
window.addEventListener('click', (e) => {
    const modals = ['hardware-modal', 'center-modal', 'edit-center-modal', 'alert-modal', 'set-barangay-location-modal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (e.target === modal) {
            modal.classList.add('hidden');
            if (modalId === 'set-barangay-location-modal') {
                selectedSearchResult = null;
            }
            editingCenterId = null;
        }
    });
});
            </script>